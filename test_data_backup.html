<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>数据备份与恢复测试</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container-fluid p-4">
      <h2>数据备份与恢复功能测试</h2>

      <div class="row">
        <div class="col-md-6">
          <div class="card" style="height: 400px">
            <div class="card-header">
              <h5><i class="bi bi-shield-check"></i> 数据备份与恢复</h5>
            </div>
            <div class="card-body">
              <div class="mb-4">
                <h6>备份状态</h6>
                <div class="d-flex align-items-center mb-3">
                  <span class="badge bg-success me-2" id="backupStatus"
                    >正常</span
                  >
                  <small class="text-muted"
                    >最后备份:
                    <span id="lastBackupTime">2024-08-09 02:00</span>
                  </small>
                </div>
                <div class="row mb-3">
                  <div class="col-6">
                    <small class="text-muted">备份大小</small>
                    <div class="fw-bold" id="backupSize">125.6 MB</div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">备份文件数</small>
                    <div class="fw-bold" id="backupFileCount">15</div>
                  </div>
                </div>
              </div>

              <div class="mb-3">
                <h6>备份设置</h6>
                <div class="mb-2">
                  <label class="form-label form-label-sm">自动备份频率</label>
                  <select
                    class="form-select form-select-sm"
                    id="backupFrequency"
                  >
                    <option value="daily" selected>每日备份</option>
                    <option value="weekly">每周备份</option>
                    <option value="monthly">每月备份</option>
                  </select>
                </div>
                <div class="mb-2">
                  <label class="form-label form-label-sm">保留备份数量</label>
                  <input
                    type="number"
                    class="form-control form-control-sm"
                    id="backupRetention"
                    value="7"
                    min="1"
                    max="30"
                  />
                </div>
              </div>

              <div class="d-grid gap-2">
                <button class="btn btn-primary btn-sm" onclick="createBackup()">
                  <i class="bi bi-download"></i> 立即备份
                </button>
                <div class="d-flex gap-2">
                  <button
                    class="btn btn-outline-success btn-sm flex-fill"
                    onclick="restoreBackup()"
                  >
                    <i class="bi bi-upload"></i> 恢复数据
                  </button>
                  <button
                    class="btn btn-outline-info btn-sm flex-fill"
                    onclick="downloadBackup()"
                  >
                    <i class="bi bi-cloud-download"></i> 下载备份
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5><i class="bi bi-info-circle"></i> 功能说明</h5>
            </div>
            <div class="card-body">
              <h6>数据备份与恢复功能特点：</h6>
              <ul class="list-unstyled">
                <li>
                  <i class="bi bi-check-circle text-success"></i> 自动定时备份
                </li>
                <li>
                  <i class="bi bi-check-circle text-success"></i> 手动立即备份
                </li>
                <li>
                  <i class="bi bi-check-circle text-success"></i> 备份文件下载
                </li>
                <li>
                  <i class="bi bi-check-circle text-success"></i> 数据恢复功能
                </li>
                <li>
                  <i class="bi bi-check-circle text-success"></i> 备份保留策略
                </li>
              </ul>

              <h6 class="mt-4">操作说明：</h6>
              <ol>
                <li><strong>立即备份</strong>：创建当前数据的备份文件</li>
                <li><strong>恢复数据</strong>：从备份文件恢复数据（需确认）</li>
                <li><strong>下载备份</strong>：下载备份文件到本地</li>
                <li><strong>自动备份</strong>：根据设置的频率自动创建备份</li>
              </ol>

              <div class="alert alert-warning mt-3">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>注意：</strong>数据恢复操作将覆盖当前数据，请谨慎操作！
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 测试按钮 -->
      <div class="row mt-4">
        <div class="col-12">
          <button id="initBtn" class="btn btn-info me-2">初始化备份状态</button>
          <button id="testAllBtn" class="btn btn-primary me-2">
            测试所有功能
          </button>
        </div>
      </div>

      <!-- 状态显示 -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="alert alert-info">
            <strong>状态：</strong><span id="status">等待测试...</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 从main.js复制的相关函数
      function updateElement(elementId, content, className = null) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = content;
          if (className) {
            element.className = className;
          }
          console.log(`更新元素 ${elementId}: ${content}`);
          return true;
        } else {
          console.error(`找不到元素: ${elementId}`);
          return false;
        }
      }

      function showSuccessMessage(message) {
        console.log("成功:", message);
        document.getElementById("status").textContent = message;

        // 创建成功提示
        const alert = document.createElement("div");
        alert.className =
          "alert alert-success alert-dismissible fade show position-fixed";
        alert.style.cssText =
          "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
        alert.innerHTML = `
                <i class="bi bi-check-circle-fill"></i>
                <strong>成功：</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
        document.body.appendChild(alert);

        setTimeout(() => {
          if (alert.parentNode) {
            alert.remove();
          }
        }, 3000);
      }

      function showErrorMessage(message) {
        console.error("错误:", message);
        document.getElementById("status").textContent = "错误: " + message;

        // 创建错误提示
        const alert = document.createElement("div");
        alert.className =
          "alert alert-danger alert-dismissible fade show position-fixed";
        alert.style.cssText =
          "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
        alert.innerHTML = `
                <i class="bi bi-exclamation-triangle-fill"></i>
                <strong>错误：</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
        document.body.appendChild(alert);

        setTimeout(() => {
          if (alert.parentNode) {
            alert.remove();
          }
        }, 5000);
      }

      // 数据备份与恢复功能
      function createBackup() {
        try {
          showSuccessMessage("正在创建数据备份...");

          // 模拟备份过程
          setTimeout(() => {
            const now = new Date();
            const backupTime = now.toLocaleString("zh-CN");
            const backupSize = (Math.random() * 50 + 100).toFixed(1) + " MB";

            // 更新备份状态
            updateElement("backupStatus", "正常", "badge bg-success");
            updateElement("lastBackupTime", backupTime);
            updateElement("backupSize", backupSize);

            // 增加备份文件数
            const currentCount = parseInt(
              document.getElementById("backupFileCount")?.textContent || "15"
            );
            updateElement("backupFileCount", (currentCount + 1).toString());

            showSuccessMessage("数据备份创建成功");
            console.log("数据备份已创建:", backupTime);
          }, 2000);
        } catch (error) {
          console.error("创建备份失败:", error);
          showErrorMessage("创建备份失败");
        }
      }

      function restoreBackup() {
        if (
          confirm("确定要恢复数据备份吗？此操作将覆盖当前数据，请谨慎操作！")
        ) {
          try {
            showSuccessMessage("正在恢复数据备份...");

            // 模拟恢复过程
            setTimeout(() => {
              updateElement("backupStatus", "已恢复", "badge bg-info");
              showSuccessMessage("数据备份恢复成功");
              console.log("数据备份已恢复");

              // 3秒后恢复正常状态
              setTimeout(() => {
                updateElement("backupStatus", "正常", "badge bg-success");
              }, 3000);
            }, 3000);
          } catch (error) {
            console.error("恢复备份失败:", error);
            showErrorMessage("恢复备份失败");
          }
        }
      }

      function downloadBackup() {
        try {
          showSuccessMessage("正在准备备份文件下载...");

          // 模拟下载过程
          setTimeout(() => {
            const now = new Date();
            const filename = `archive_backup_${now.getFullYear()}${(
              now.getMonth() + 1
            )
              .toString()
              .padStart(2, "0")}${now
              .getDate()
              .toString()
              .padStart(2, "0")}.zip`;

            showSuccessMessage(`备份文件 ${filename} 下载完成`);
            console.log("备份文件下载:", filename);
          }, 1500);
        } catch (error) {
          console.error("下载备份失败:", error);
          showErrorMessage("下载备份失败");
        }
      }

      function updateBackupSettings() {
        try {
          const frequency =
            document.getElementById("backupFrequency")?.value || "daily";
          const retention =
            document.getElementById("backupRetention")?.value || "7";

          console.log("备份设置已更新:", { frequency, retention });
          showSuccessMessage("备份设置已保存");
        } catch (error) {
          console.error("更新备份设置失败:", error);
          showErrorMessage("保存备份设置失败");
        }
      }

      function initializeBackupStatus() {
        try {
          // 设置初始备份状态
          const lastBackupTime = new Date(Date.now() - 6 * 60 * 60 * 1000); // 6小时前
          updateElement(
            "lastBackupTime",
            lastBackupTime.toLocaleString("zh-CN")
          );
          updateElement("backupSize", "125.6 MB");
          updateElement("backupFileCount", "15");
          updateElement("backupStatus", "正常", "badge bg-success");

          // 绑定备份设置变更事件
          const backupFrequency = document.getElementById("backupFrequency");
          const backupRetention = document.getElementById("backupRetention");

          if (backupFrequency) {
            backupFrequency.addEventListener("change", updateBackupSettings);
          }

          if (backupRetention) {
            backupRetention.addEventListener("change", updateBackupSettings);
          }

          console.log("备份状态初始化完成");
          showSuccessMessage("备份状态初始化完成");
        } catch (error) {
          console.error("初始化备份状态失败:", error);
          showErrorMessage("初始化备份状态失败");
        }
      }

      function testAllFunctions() {
        console.log("=== 开始测试所有功能 ===");

        // 1. 初始化
        initializeBackupStatus();

        // 2. 测试创建备份
        setTimeout(() => {
          console.log("测试创建备份...");
          createBackup();
        }, 1000);

        // 3. 测试下载备份
        setTimeout(() => {
          console.log("测试下载备份...");
          downloadBackup();
        }, 4000);

        // 4. 测试设置更新
        setTimeout(() => {
          console.log("测试设置更新...");
          document.getElementById("backupFrequency").value = "weekly";
          document.getElementById("backupRetention").value = "10";
          updateBackupSettings();
        }, 6000);

        console.log("=== 所有功能测试已启动 ===");
      }

      // 事件绑定
      document.addEventListener("DOMContentLoaded", function () {
        console.log("页面加载完成");

        document
          .getElementById("initBtn")
          .addEventListener("click", initializeBackupStatus);
        document
          .getElementById("testAllBtn")
          .addEventListener("click", testAllFunctions);

        // 自动初始化
        setTimeout(initializeBackupStatus, 500);
      });
    </script>
  </body>
</html>
