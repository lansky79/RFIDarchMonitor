<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>维护数据调试测试</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container-fluid p-4">
      <h2>维护数据调试测试</h2>

      <!-- 维护统计 -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h6>总维护记录</h6>
              <span id="totalMaintenanceCount" class="h4">--</span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h6>已计划</h6>
              <span id="scheduledMaintenanceCount" class="h4">--</span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h6>已完成</h6>
              <span id="completedMaintenanceCount" class="h4">--</span>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card">
            <div class="card-body">
              <h6>逾期</h6>
              <span id="overdueMaintenanceCount" class="h4">--</span>
            </div>
          </div>
        </div>
      </div>

      <!-- 维护记录表格 -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h6>维护记录</h6>
            </div>
            <div class="card-body">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>设备名称</th>
                    <th>设备类型</th>
                    <th>维护类型</th>
                    <th>计划日期</th>
                    <th>技术员</th>
                    <th>状态</th>
                    <th>费用</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="maintenanceTableBody">
                  <!-- 维护记录将在这里显示 -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 测试按钮 -->
      <div class="row mt-4">
        <div class="col-12">
          <button id="testLoadBtn" class="btn btn-primary me-2">
            测试加载维护数据
          </button>
          <button id="testMockBtn" class="btn btn-success me-2">
            直接显示模拟数据
          </button>
          <button id="checkElementsBtn" class="btn btn-info me-2">
            检查页面元素
          </button>
        </div>
      </div>

      <!-- 调试信息 -->
      <div class="row mt-4">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h6>调试信息</h6>
            </div>
            <div class="card-body">
              <pre id="debugInfo">等待测试...</pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 模拟main.js中的相关函数
      function updateElement(elementId, content, className = null) {
        const element = document.getElementById(elementId);
        if (element) {
          element.textContent = content;
          if (className) {
            element.className = className;
          }
          return true;
        }
        return false;
      }

      function formatDateTime(datetime) {
        if (!datetime) return "--";
        const date = new Date(datetime);
        return date.toLocaleString("zh-CN");
      }

      function getDeviceTypeText(deviceType) {
        const deviceTypes = {
          rfid: "RFID设备",
          sensor: "传感器",
          camera: "摄像头",
          controller: "控制器",
        };
        return deviceTypes[deviceType] || "未知类型";
      }

      function getMaintenanceTypeText(maintenanceType) {
        const maintenanceTypes = {
          routine: "定期检查",
          preventive: "预防性维护",
          repair: "故障维修",
          calibration: "设备校准",
        };
        return maintenanceTypes[maintenanceType] || "未知类型";
      }

      function getMaintenanceStatusClass(status) {
        const statusClasses = {
          scheduled: "bg-warning",
          in_progress: "bg-info",
          completed: "bg-success",
          overdue: "bg-danger",
          cancelled: "bg-secondary",
        };
        return statusClasses[status] || "bg-secondary";
      }

      function getMaintenanceStatusText(status) {
        const statusTexts = {
          scheduled: "已计划",
          in_progress: "进行中",
          completed: "已完成",
          overdue: "逾期",
          cancelled: "已取消",
        };
        return statusTexts[status] || "未知状态";
      }

      function displayMaintenanceRecords(records) {
        const tbody = document.getElementById("maintenanceTableBody");
        if (!tbody) {
          console.error("找不到maintenanceTableBody元素");
          return;
        }

        console.log("显示维护记录:", records.length, "条");

        tbody.innerHTML = records
          .map((record) => {
            const statusClass = getMaintenanceStatusClass(record.status);
            const statusText = getMaintenanceStatusText(record.status);

            return `
                    <tr>
                        <td>${record.device_name || "未知设备"}</td>
                        <td>${getDeviceTypeText(record.device_type)}</td>
                        <td>${getMaintenanceTypeText(
                          record.maintenance_type
                        )}</td>
                        <td>${formatDateTime(record.scheduled_date)}</td>
                        <td>${record.technician || "未分配"}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>¥${(record.cost || 0).toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                    `;
          })
          .join("");
      }

      function displayMockMaintenanceRecords() {
        const mockRecords = [
          {
            id: 1,
            device_name: "RFID_READER_001",
            device_type: "rfid",
            maintenance_type: "routine",
            scheduled_date: new Date(
              Date.now() - 2 * 24 * 60 * 60 * 1000
            ).toISOString(),
            technician: "张明",
            status: "completed",
            cost: 150.0,
          },
          {
            id: 2,
            device_name: "RFID_READER_002",
            device_type: "rfid",
            maintenance_type: "preventive",
            scheduled_date: new Date(
              Date.now() + 3 * 24 * 60 * 60 * 1000
            ).toISOString(),
            technician: "李华",
            status: "scheduled",
            cost: 200.0,
          },
          {
            id: 3,
            device_name: "SENSOR_001",
            device_type: "sensor",
            maintenance_type: "calibration",
            scheduled_date: new Date(
              Date.now() - 1 * 24 * 60 * 60 * 1000
            ).toISOString(),
            technician: "陈磊",
            status: "in_progress",
            cost: 100.0,
          },
          {
            id: 4,
            device_name: "SENSOR_002",
            device_type: "sensor",
            maintenance_type: "routine",
            scheduled_date: new Date(
              Date.now() - 5 * 24 * 60 * 60 * 1000
            ).toISOString(),
            technician: "赵强",
            status: "completed",
            cost: 120.0,
          },
          {
            id: 5,
            device_name: "RFID_READER_003",
            device_type: "rfid",
            maintenance_type: "repair",
            scheduled_date: new Date(
              Date.now() + 1 * 24 * 60 * 60 * 1000
            ).toISOString(),
            technician: "陈工",
            status: "scheduled",
            cost: 350.0,
          },
        ];

        displayMaintenanceRecords(mockRecords);
      }

      async function loadMaintenanceStatistics() {
        try {
          // 显示模拟数据
          updateElement("totalMaintenanceCount", "10");
          updateElement("scheduledMaintenanceCount", "4");
          updateElement("completedMaintenanceCount", "5");
          updateElement("overdueMaintenanceCount", "1");
          console.log("维护统计数据已更新");
        } catch (error) {
          console.error("加载维护统计失败:", error);
        }
      }

      async function loadMaintenanceRecords() {
        try {
          console.log("开始加载维护记录...");
          displayMockMaintenanceRecords();
          console.log("维护记录加载完成");
        } catch (error) {
          console.error("加载维护记录失败:", error);
        }
      }

      async function loadMaintenanceData() {
        try {
          console.log("开始加载维护数据...");
          await loadMaintenanceStatistics();
          await loadMaintenanceRecords();
          console.log("维护数据加载完成");
        } catch (error) {
          console.error("加载维护数据失败:", error);
        }
      }

      function checkElements() {
        const elements = [
          "totalMaintenanceCount",
          "scheduledMaintenanceCount",
          "completedMaintenanceCount",
          "overdueMaintenanceCount",
          "maintenanceTableBody",
        ];

        let info = "页面元素检查结果:\n";
        elements.forEach((id) => {
          const element = document.getElementById(id);
          info += `${id}: ${element ? "存在" : "不存在"}\n`;
        });

        document.getElementById("debugInfo").textContent = info;
      }

      // 事件绑定
      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("testLoadBtn")
          .addEventListener("click", async () => {
            console.log("=== 测试加载维护数据 ===");
            await loadMaintenanceData();
            document.getElementById("debugInfo").textContent =
              "维护数据加载测试完成，请查看控制台日志";
          });

        document.getElementById("testMockBtn").addEventListener("click", () => {
          console.log("=== 直接显示模拟数据 ===");
          displayMockMaintenanceRecords();
          loadMaintenanceStatistics();
          document.getElementById("debugInfo").textContent = "模拟数据显示完成";
        });

        document
          .getElementById("checkElementsBtn")
          .addEventListener("click", checkElements);

        // 初始检查
        checkElements();
      });
    </script>
  </body>
</html>
